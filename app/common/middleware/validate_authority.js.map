{"version":3,"sources":["../../../src/common/middleware/validate_authority.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;IAAqB,iB;;;;;;;;8BACnB,I,mBAAc;AAAA;;AAAA,sCAAN,IAAM;AAAN,UAAM;AAAA;;AACZ,8DAAM,IAAN,mDAAc,IAAd;AACA,SAAK,SAAL,GAAiB,MAAM,KAAN,CAAY,MAAZ,EAAoB,SAApB,EAA+B,MAA/B,CAAjB;AACA,SAAK,SAAL,GAAiB,MAAM,KAAN,CAAY,MAAZ,EAAoB,SAApB,EAA+B,MAA/B,CAAjB;AACD,G;;8BAEK,G;;;;;;;AACA,sB,GAAW,KAAK,IAAL,CAAU,Q;;qBACR,KAAK,IAAL,CAAU,OAAV,CAAkB,MAAlB,C;;;AAAb,kB;;qBAEoB,KAAK,IAAL,CAAU,OAAV,CAAkB,aAAlB,C;;;AAApB,yB;;oBAGA,CAAC,WAAD,IAAgB,MAAM,OAAN,CAAc,WAAd,C;;;;;mBACd,I;;;;;;qBAEkB,KAAK,SAAL,CAAe,kBAAf,CAAkC,KAAK,QAAvC,C;;;AAApB,yB;;;;;;qBAIoB,KAAK,SAAL,CAAe,kBAAf,CAAkC,WAAlC,C;;;AAApB,yB;;;;qBAEI,KAAK,IAAL,CAAU,OAAV,CAAkB,aAAlB,EAAiC,WAAjC,C;;;kBAGH,KAAK,SAAL,CAAe,QAAf,EAAyB,WAAzB,C;;;;;;qBACG,KAAK,IAAL,CAAU,IAAV,CAAe,cAAf,C;;;AACN,mBAAK,IAAL,CAAU,GAAV;+CACO,MAAM,OAAN,E;;;;;;;;;;;;;;;;;AAIX;;;8BACA,S,sBAAU,Q,EAAU,W,EAAa;AAC/B,QAAI,YAAY,KAAhB;AACA,gBAAY,OAAZ,CAAoB,UAAC,CAAD,EAAM;AACxB,QAAE,KAAF,CAAQ,OAAR,CAAgB,UAAC,CAAD,EAAM;;AAEpB,YAAI,MAAM,cAAN,CAAqB,CAArB,CAAJ,EAA6B;AAC3B;AACA,cAAE,KAAK,CAAL,CAAF;AACA,cAAI,SAAS,KAAT,CAAe,CAAf,CAAJ,EAAuB;AACrB,wBAAY,IAAZ;AACD;AACF,SAND,MAMO;AACL,cAAI,KAAK,QAAT,EAAmB;AACjB,wBAAY,IAAZ;AACD;AACF;AACF,OAbD;AAcD,KAfD;;AAiBA,WAAO,SAAP;AACD,G;;;EAtD4C,MAAM,UAAN,CAAiB,I;;kBAA3C,iB","file":"validate_authority.js","sourcesContent":["export default class ValidateAuthority extends think.middleware.base {\r\n  init(...args) {\r\n    super.init(...args);\r\n    this.userModel = think.model('user', undefined, 'home');\r\n    this.roleModel = think.model('role', undefined, 'home');\r\n  }\r\n\r\n  async run() {\r\n    let pathname = this.http.pathname;\r\n    let user = await this.http.session('user');\r\n\r\n    let authorities = await this.http.session('authorities');\r\n\r\n\r\n    if (!authorities || think.isEmpty(authorities)) {\r\n      if (user) {\r\n        //已登录\r\n        authorities = await this.userModel.getUserAuthorities(user.username);\r\n\r\n      } else {\r\n        //未登录\r\n        authorities = await this.roleModel.getRoleAuthorities('anonymous');\r\n      }\r\n      await this.http.session('authorities', authorities);\r\n    }\r\n\r\n    if (!this._validate(pathname, authorities)) {\r\n      await this.http.fail('NO_AUTHORITY');\r\n      this.http.end();\r\n      return think.prevent();\r\n    }\r\n  }\r\n\r\n  //基于URL的权限验证实现主方法\r\n  _validate(pathname, authorities) {\r\n    let validated = false;\r\n    authorities.forEach((i)=> {\r\n      i.paths.forEach((o)=> {\r\n\r\n        if (think.isStringExpReg(o)) {\r\n          //string to RegExp\r\n          o=eval(o);\r\n          if (pathname.match(o)) {\r\n            validated = true;\r\n          }\r\n        } else {\r\n          if (o == pathname) {\r\n            validated = true;\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    return validated;\r\n  }\r\n}"]}