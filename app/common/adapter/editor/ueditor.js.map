{"version":3,"sources":["../../../../src/common/adapter/editor/ueditor.js"],"names":[],"mappings":"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","file":"ueditor.js","sourcesContent":["'use strict';\n/**\n * base adapter\n */\nimport fs from 'fs';\nimport path from 'path';\nimport http from 'http';\nexport default class extends think.adapter.base {\n  /**\n   * init\n   * @return {[]}         []\n   */\n  init(fileField, config, type, http) {\n    type = type || \"upload\";\n    //super.init(http);\n    this.http = http;\n    this.fileField = fileField;\n    this.config = config;\n    this.type = type;\n    if (type == \"remote\") {\n      //await this.saveRemote();\n    } else if (type == \"base64\") {\n      this.upBase64();\n    } else {\n      this.upFile();\n    }\n\n  }\n\n  /**\n   * 上传文件的主处理方法\n   * @return mixed\n   */\n  upFile() {\n    let http = this.http;\n    let file = http.file(this.fileField);\n    //console.log(file);\n    if (!think.isFile(file.path)) {\n      this.stateInfo = \"找不到临时文件\";\n      return;\n    }\n\n    this.oriName = file.originalFilename;\n    this.fileSize = file.size;\n    this.fileType = this.getFileExt();\n    this.fullName = this.getFullName();\n    this.filePath = this.getFilePath();\n    this.fileName = this.getFileName();\n    think.mkdir(this.filePath.replace(this.fileName, \"\"));\n    //检查文件大小是否超出限制\n    if (!this.checkSize()) {\n      this.stateInfo = \"文件大小超出网站限制\";\n      return;\n    }\n    //检查是否不允许的文件格式\n    if (!this.checkType()) {\n      this.stateInfo = \"文件类型不允许\";\n      return;\n    }\n    //移动文件\n    fs.renameSync(file.path, this.filePath);\n    if (think.isFile(this.filePath)) {\n      this.stateInfo = \"SUCCESS\";\n    } else {\n      this.stateInfo = '文件保存时出错';\n    }\n\n  }\n\n  /**\n   * 处理base64编码的图片上传\n   * @return mixed\n   */\n  upBase64() {\n    let http = this.http;\n    let base64Data = http.post(this.fileField);\n    let img = new Buffer(base64Data, 'base64');\n    //console.log(img.length);\n    this.oriName = this.config['oriName'];\n    //console.log(this.oriName);\n    this.fileSize = img.length;\n    this.fileType = this.getFileExt();\n    this.fullName = this.getFullName();\n    this.filePath = this.getFilePath();\n    this.fileName = this.getFileName();\n    think.mkdir(this.filePath.replace(this.fileName, \"\"));\n\n    //检查文件大小是否超出限制\n    //if (!this.checkSize()) {\n    //  this.stateInfo = \"文件大小超出网站限制\";\n    //  return;\n    //}\n    ////检查是否不允许的文件格式\n    //if (!this.checkType()) {\n    //  this.stateInfo = \"文件类型不允许\";\n    //  return;\n    //}\n    //移动文件\n    //fs.renameSync(img, this.filePath);\n    fs.writeFileSync(this.filePath, img);\n    if (think.isFile(this.filePath)) {\n      this.stateInfo = \"SUCCESS\";\n    } else {\n      this.stateInfo = '文件保存时出错';\n    }\n\n  }\n\n  spiderImage(imgUrl, filePath) {\n    let deferred = think.defer();\n    http.get(imgUrl, function (res) {\n      var imgData = \"\";\n      res.setEncoding(\"binary\");\n      res.on(\"data\", function (chunk) {\n        imgData += chunk;\n      });\n\n      res.on(\"end\", function () {\n        fs.writeFileSync(filePath, imgData, \"binary\");\n        deferred.resolve(filePath);\n      });\n    });\n    return deferred.promise;\n  }\n\n  /**\n   * 拉取远程图片\n   * @return mixed\n   */\n  async saveRemote() {\n    think.log(\"dddddd\")\n    let imgUrl = this.fileField;\n    //imgUrl = imgUrl.replace(/&amp;/,\"&\");\n    //http开头验证\n    if (imgUrl.indexOf(\"http\") !== 0) {\n      this.stateInfo = \"链接不是http链接\";\n      return;\n    }\n    //TODO 各种验证后面弄\n    let m = imgUrl.match(/[\\/]([^\\/]*)[\\.]?[^\\.\\/]*$/)[1];\n    this.oriName = m ? m : \"\";\n    //console.log(this.oriName);\n    this.fileSize = imgUrl.length;//TODO 这里有问题，后面弄\n    this.fileType = this.getFileExt();\n    this.fullName = this.getFullName();\n    this.filePath = this.getFilePath();\n    this.fileName = this.getFileName();\n    let filePath = this.filePath;\n    let fullName = this.fullName;\n    think.mkdir(this.filePath.replace(this.fileName, \"\"));\n    let promises = await this.spiderImage(imgUrl, filePath);\n    // console.log(promises);\n    if (think.isFile(promises)) {\n      this.stateInfo = \"SUCCESS\";\n    } else {\n      this.stateInfo = '文件保存时出错';\n    }\n    return {\n      \"state\": this.stateInfo,\n      \"url\": this.fullName,\n      \"title\": this.fileName,\n      \"original\": this.oriName,\n      \"type\": this.fileType,\n      \"size\": this.fileSize\n    };\n  }\n\n  /**\n   * 获取文件扩展名\n   * @return string\n   */\n  getFileExt() {\n\n    return this.oriName.substr(this.oriName.lastIndexOf(\".\")).toLocaleLowerCase();\n  }\n\n  /**\n   * 重命名文件\n   * @return string\n   */\n  getFullName() {\n    //替换目录日期事件\n    ///ueditor/php/upload/image/{yyyy}{mm}{dd}/{time}{rand:6}\n    //var filename= this.filed;\n    var format = this.config.pathFormat;\n    var d = new Date();\n    var t = d.getTime();\n    var date = {};\n    date.yyyy = d.getFullYear();\n    date.mm = (d.getMonth() + 1) < 10 ? \"0\" + (d.getMonth() + 1) : d.getMonth() + 1;\n    date.dd = (d.getDate() < 10 ? \"0\" : \"\") + d.getDate();\n    format = format.replace(\"{yyyy}\", date.yyyy);\n    format = format.replace(\"{mm}\", date.mm);\n    format = format.replace(\"{dd}\", date.dd);\n    format = format.replace(\"{time}\", t);\n    //计算随机数\n    var str = format.match(/\\{rand\\:[\\d]*\\}/i)\n    var index = str[0].search(/:/) + 1;\n    index = str[0].charAt(index);\n    var rand = Math.random();\n    rand = rand.toString();\n    rand = rand.substr(2, index);\n    //替换随机数\n    format = format.replace(str[0], rand);\n    var ext = this.getFileExt();\n    return format + ext;\n  }\n\n  /**\n   * 获取文件完整路径\n   * @return string\n   */\n  getFilePath() {\n\n    if (this.fullName.substr(0, 1) != '/') {\n      this.fullName = '/' + this.fullName;\n    }\n\n    return think.UPLOAD_PATH + this.fullName;\n  }\n\n  /**\n   * 获取文件名\n   * @return string\n   */\n  getFileName() {\n    return path.basename(this.filePath);\n  }\n\n  /**\n   * 文件类型检测\n   * @return boolean\n   */\n  checkType() {\n    return this.config[\"allowFiles\"].includes(this.getFileExt());\n  }\n\n  /**\n   * 文件大小检测\n   * @return boolean\n   */\n  checkSize() {\n    return this.fileSize <= (this.config[\"maxSize\"]);\n  }\n\n  /**\n   * 获取当前上传成功文件的各项信息\n   * @return object\n   */\n  getFileInfo() {\n    return {\n      \"state\": this.stateInfo,\n      \"url\": this.fullName,\n      \"title\": this.fileName,\n      \"original\": this.oriName,\n      \"type\": this.fileType,\n      \"size\": this.fileSize\n    };\n  }\n}"]}