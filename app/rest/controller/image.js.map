{"version":3,"sources":["../../../src/rest/controller/image.js"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;AAEA;;;;;;AACA,IAAI,KAAK,QAAQ,IAAR,CAAT;AACA,IAAI,OAAO,QAAQ,MAAR,CAAX;AACA,IAAI,OAAO,QAAQ,MAAR,CAAX;;AAGA,IAAI,cAAc,MAAM,SAAN,CAAgB,GAAG,MAAnB,EAA2B,EAA3B,CAAlB;AACA,IAAI,cAAc,MAAM,SAAN,CAAgB,GAAG,MAAnB,EAA2B,EAA3B,CAAlB;AACA,IAAI,gBAAgB,MAAM,SAAN,CAAgB,GAAG,QAAnB,EAA6B,EAA7B,CAApB;;;;;;;;;;AAGE;;;;mBAIM,Q;;;;;;;AAEJ,mBAAK,aAAL,GAAqB,MAAM,KAAN,CAAY,OAAZ,EAAqB,IAArB,EAA2B,KAA3B,CAArB;;qBACqB,KAAK,aAAL,CAAmB,KAAnB,E;;;AAArB,mBAAK,O;;AACL,mBAAK,UAAL,GAAkB,KAAlB;;qBACa,gBAAM,QAAN,W;;;;;;;;;;;;;;;;;;;;mBAIT,U;;;;;;;AACJ;AACI,mB,GAAQ,MAAM,MAAN,CAAa,EAAb,EAAiB,KAAK,IAAL,CAAU,OAAV,CAAjB,C;;mBAER,MAAM,OAAN,CAAc,KAAd,C;;;;;gDACK,KAAK,IAAL,CAAU,gBAAV,C;;;;AAGT,kBAAI,CAAC,MAAM,GAAN,CAAL,EACE,QAAQ,EAAC,KAAK,KAAN,EAAR;;AAEE,sB,GAAW,E;wDAED,K;;;;;;;;AAAL,e;AACH,kB,GAAO,MAAM,CAAN,C;AACP,sB,GAAW,KAAK,I;AAEhB,sB,GAAW,YAAY,IAAZ,CAAiB,KAAK,gBAAtB,C,EAAyC;AACxD;;;AAGI,sB,GAAW,KAAK,EAAL,KAAY,Q;AACvB,qB,GAAU,Q;AACV,sB,GAAW,KAAK,IAAL,CAAU,MAAM,WAAhB,EAA6B,OAA7B,C;;AACf,oBAAM,KAAN,CAAY,QAAZ;;qBACM,YAAY,QAAZ,EAAsB,KAAK,IAAL,CAAU,QAAV,EAAoB,QAApB,CAAtB,C;;;AACN,uBAAS,IAAT,CAAc;AACZ,8BAAc,KAAK,gBADP;AAEZ,wBAAQ,YAAY,aAAZ,GAA4B,GAA5B,GAAkC,OAAlC,GAA4C,GAA5C,GAAkD;AAF9C,eAAd;;;;;AAME,wB,GAAa,MAAM,KAAN,CAAY,OAAZ,EAAqB,IAArB,EAA2B,KAA3B,C;;qBACE,WAAW,OAAX,CAAmB,QAAnB,C;;;AAAf,oB;gDAEG,MAAM,OAAN,CAAc,MAAd,IAAwB,KAAK,IAAL,CAAU,mBAAV,CAAxB,GAAyD,KAAK,OAAL,CAAa,MAAb,C;;;;;;;;;;;;;;;;;mBAG5D,S;;;;;;;kBACC,KAAK,E;;;;;gDACD,KAAK,IAAL,CAAU,aAAV,C;;;AAEL,wB,GAAa,MAAM,KAAN,CAAY,OAAZ,EAAqB,IAArB,EAA2B,KAA3B,C;;;AAEf,sBAAQ,GAAR,CAAY,KAAK,EAAjB;;qBACmB,WAAW,SAAX,CAAqB,KAAK,EAA1B,C;;;AAAf,oB;;qBACa,cAAc,OAAO,CAAP,EAAU,QAAxB,C;;;AAAb,kB;;;AAEJ,mBAAK,IAAL,CAAU,SAAV;gDACO,KAAK,GAAL,CAAS,IAAT,C;;;;;gDAEA,KAAK,IAAL,CAAU,eAAV,C","file":"image.js","sourcesContent":["'use strict';\n\nimport Base from './base.js';\nvar fs = require('fs');\nvar path = require('path');\nvar uuid = require(\"uuid\")\n\n\nlet renameAsync = think.promisify(fs.rename, fs);\nlet existsAsync = think.promisify(fs.exists, fs);\nlet readFileAsync = think.promisify(fs.readFile, fs);\n\nexport default class extends Base {\n  /**\n   * index action\n   * @return {Promise} []\n   */\n  async __before() {\n\n    this.modelInstance = think.model('image', null, 'api');\n    this.modelPk = await this.modelInstance.getPk();\n    this.needPaging = false;\n    return await super.__before();\n  }\n\n\n  async postAction() {\n    //这里的 key 需要和 form 表单里的 name 值保持一致\n    var files = think.extend({}, this.file('files'));\n\n    if (think.isEmpty(files)) {\n      return this.fail('NO_UPLOAD_FILE');\n    }\n\n    if (!files[\"0\"])\n      files = {'0': files};\n\n    let picInfos = [];\n\n    for (let f in files) {\n      let file = files[f];\n      let filepath = file.path;\n\n      let fileType = /\\.[^\\.]+$/.exec(file.originalFilename); // 判断后缀名\n      //文件上传后，需要将文件移动到项目其他地方，否则会在请求结束时删除掉该文件\n\n\n      let baseName = uuid.v1() + fileType;\n      let subpath = 'images';\n      let basePath = path.join(think.UPLOAD_PATH, subpath);\n      think.mkdir(basePath);\n      await renameAsync(filepath, path.join(basePath, baseName));\n      picInfos.push({\n        \"originName\": file.originalFilename,\n        \"path\": \"file://\" + 'UPLOAD_PATH' + '/' + subpath + '/' + baseName\n      });\n    }\n\n    let imageModel = think.model(\"image\", null, 'api');\n    let result = await imageModel.addMany(picInfos);\n\n    return think.isEmpty(result) ? this.fail(\"Failed to upload!\") : this.success(result);\n  }\n\n  async getAction() {\n    if (!this.id) {\n      return this.fail('NO_IMAGE_ID');\n    }\n    let imageModel = think.model('image', null, 'api');\n    try {\n      console.log(this.id);\n      let images = await imageModel.getImages(this.id);\n      let file = await readFileAsync(images[0].realPath);\n\n      this.type('image/*');\n      return this.end(file);\n    } catch (e) {\n      return this.fail('NO_THIS_IMAGE');\n    }\n\n\n  }\n}"]}