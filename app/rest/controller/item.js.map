{"version":3,"sources":["../../../src/rest/controller/item.js"],"names":["Item","__before","modelInstance","think","model","getPk","modelPk","needPaging","listOrder","postAction","data","post","isEmpty","fail","session","user","id","author","publisher","add","insertId","checkStatus","now","Date","item","param","auctionBeginTime","setCheckStatusTimer","auctionEndTime","success","putAction","where","update","rows","affectedRows"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;;;IAEqBA,I;;;;;;;;iBAEbC,Q;;;;;;AACJ,mBAAKC,aAAL,GAAqBC,MAAMC,KAAN,CAAY,MAAZ,EAAoB,IAApB,EAA0B,KAA1B,CAArB;;qBACqB,KAAKF,aAAL,CAAmBG,KAAnB,E;;;AAArB,mBAAKC,O;;AACL,mBAAKC,UAAL,GAAkB,KAAlB;AACA,mBAAKC,SAAL,GAAiB,EAAC,YAAY,MAAb,EAAjB;;qBACa,gBAAMP,QAAN,W;;;;;;;;;;;;;;;;;;;;iBAGTQ,U;;;;;;;AAEAC,kB,GAAO,KAAKC,IAAL,E;;AACX,qBAAOD,KAAK,KAAKJ,OAAV,CAAP;;mBACIH,MAAMS,OAAN,CAAcF,IAAd,C;;;;;gDACK,KAAKG,IAAL,CAAU,eAAV,C;;;;qBAEQ,KAAKC,OAAL,CAAa,MAAb,C;;;AAAbC,kB;;AACJ,kBAAI,CAACZ,MAAMS,OAAN,CAAcG,IAAd,CAAL,EAA0B;AACxBL,qBAAKK,IAAL,GAAYA,KAAKC,EAAjB;AACAN,qBAAKO,MAAL,GAAcF,KAAKC,EAAnB;AACAN,qBAAKQ,SAAL,GAAiBH,KAAKC,EAAtB;AACD;;;qBAEoB,KAAKd,aAAL,CAAmBiB,GAAnB,CAAuBT,IAAvB,C;;;AAAjBU,sB;;qBAEE,KAAKlB,aAAL,CAAmBmB,WAAnB,E;;;AAEFC,iB,GAAM,CAAC,IAAIC,IAAJ,E;AACPC,kB,GAAO,KAAKC,KAAL,E;;;AAEX,kBAAID,KAAKE,gBAAL,GAAwBJ,GAAxB,GAA8B,CAAlC,EACE,KAAKpB,aAAL,CAAmByB,mBAAnB,CAAuCH,KAAKE,gBAAL,GAAwBJ,GAA/D;AACF,kBAAIE,KAAKI,cAAL,GAAsBN,GAAtB,GAA4B,CAAhC,EACE,KAAKpB,aAAL,CAAmByB,mBAAnB,CAAuCH,KAAKI,cAAL,GAAsBN,GAA7D;;gDAEK,KAAKO,OAAL,CAAa,EAACb,IAAII,QAAL,EAAb,C;;;;;;;;;;;;;;;;;iBAGHU,S;;;;;;;;;kBACC,KAAKd,E;;;;;gDACD,KAAKH,IAAL,CAAU,cAAV,C;;;AAELH,kB,GAAO,KAAKC,IAAL,E;;AACX,qBAAOD,KAAK,KAAKJ,OAAV,CAAP;;mBACIH,MAAMS,OAAN,CAAcF,IAAd,C;;;;;gDACK,KAAKG,IAAL,CAAU,eAAV,C;;;;qBAEQ,KAAKX,aAAL,CAAmB6B,KAAnB,kDAA2B,KAAKzB,OAAhC,IAA0C,KAAKU,EAA/C,yBAAoDgB,MAApD,CAA2DtB,IAA3D,C;;;AAAbuB,kB;;qBAEE,KAAK/B,aAAL,CAAmBmB,WAAnB,E;;;AAEFC,iB,GAAM,CAAC,IAAIC,IAAJ,E;AACPC,kB,GAAO,KAAKC,KAAL,E;;;AAEX,kBAAID,KAAKE,gBAAL,GAAwBJ,GAAxB,GAA8B,CAAlC,EACE,KAAKpB,aAAL,CAAmByB,mBAAnB,CAAuCH,KAAKE,gBAAL,GAAwBJ,GAA/D;AACF,kBAAIE,KAAKI,cAAL,GAAsBN,GAAtB,GAA4B,CAAhC,EACE,KAAKpB,aAAL,CAAmByB,mBAAnB,CAAuCH,KAAKI,cAAL,GAAsBN,GAA7D;;gDAEK,KAAKO,OAAL,CAAa,EAACK,cAAcD,IAAf,EAAb,C;;;;;;;;;;;;;;;;;;;;kBA5DUjC,I","file":"item.js","sourcesContent":["import Base from './base';\r\n\r\nexport default class Item extends Base {\r\n\r\n  async __before() {\r\n    this.modelInstance = think.model('item', null, 'api');\r\n    this.modelPk = await this.modelInstance.getPk();\r\n    this.needPaging = false;\r\n    this.listOrder = {'createAt': 'desc'};\r\n    return await super.__before();\r\n  }\r\n\r\n  async postAction() {\r\n\r\n    let data = this.post();\r\n    delete data[this.modelPk];\r\n    if (think.isEmpty(data)) {\r\n      return this.fail(\"data is empty\");\r\n    }\r\n    let user = await this.session('user');\r\n    if (!think.isEmpty(user)) {\r\n      data.user = user.id;\r\n      data.author = user.id;\r\n      data.publisher = user.id;\r\n    }\r\n\r\n    let insertId = await this.modelInstance.add(data);\r\n\r\n    await this.modelInstance.checkStatus();\r\n\r\n    let now = +new Date();\r\n    let item = this.param();\r\n\r\n    if (item.auctionBeginTime - now > 0)\r\n      this.modelInstance.setCheckStatusTimer(item.auctionBeginTime - now);\r\n    if (item.auctionEndTime - now > 0)\r\n      this.modelInstance.setCheckStatusTimer(item.auctionEndTime - now);\r\n\r\n    return this.success({id: insertId});\r\n  }\r\n\r\n  async putAction() {\r\n    if (!this.id) {\r\n      return this.fail(\"params error\");\r\n    }\r\n    let data = this.post();\r\n    delete data[this.modelPk];\r\n    if (think.isEmpty(data)) {\r\n      return this.fail(\"data is empty\");\r\n    }\r\n    let rows = await this.modelInstance.where({[this.modelPk]: this.id}).update(data);\r\n\r\n    await this.modelInstance.checkStatus();\r\n\r\n    let now = +new Date();\r\n    let item = this.param();\r\n\r\n    if (item.auctionBeginTime - now > 0)\r\n      this.modelInstance.setCheckStatusTimer(item.auctionBeginTime - now);\r\n    if (item.auctionEndTime - now > 0)\r\n      this.modelInstance.setCheckStatusTimer(item.auctionEndTime - now);\r\n\r\n    return this.success({affectedRows: rows});\r\n  }\r\n}"]}