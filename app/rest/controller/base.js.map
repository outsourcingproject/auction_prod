{"version":3,"sources":["../../../src/rest/controller/base.js"],"names":[],"mappings":"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","file":"base.js","sourcesContent":["'use strict';\n\nexport default class Base extends think.controller.rest {\n  modelInstance;\n  modelPk;\n\n  needPaging;\n  pageCount;\n  listOrder;\n  filter;\n  join;\n  field;\n\n  init(...args) {\n    super.init(...args);\n    this.modelInstance = null;\n    this.modelPk = null;\n    this.needPaging = 1;\n    this.pageCount = think.config('site.defaultPageCount');\n    this.listOrder = {'createAt': 'desc'}\n    this.filter = {};\n    this.join = '';\n    this.field = '';\n    //允许rest API使用post访问\n    this._method = '_method';\n  }\n\n  //允许跨域访问\n  __before() {\n    let method = this.http.method.toLowerCase();\n    this._setCorsHeader();\n    if (method === \"options\") {\n      return this.end();\n    }\n\n  }\n\n  _setCorsHeader() {\n    this.header(\"Access-Control-Allow-Origin\", this.header(\"origin\") || \"*\");\n    this.header(\"Access-Control-Allow-Headers\", \"Origin, No-Cache, X-Requested-With, If-Modified-Since, Pragma, Last-Modified, Cache-Control, Expires, Content-Type, Set-Cookie,*\");\n    this.header(\"Access-Control-Request-Method\", \"GET,POST,PUT,DELETE\");\n    this.header(\"Access-Control-Allow-Credentials\", \"true\");\n  }\n\n  async getAction() {\n    let data;\n    if (this.id) {\n      data = await this.modelInstance\n        .where({[this.modelPk]: this.id})\n        .find();\n    } else {\n      let filter = this.filter;\n      let listOrder = this.param('listOrder');\n      let needPaging = +(this.param('needPaging') || this.needPaging);\n      let pageNo = +this.param('pageNo') > 0 ? +this.param('pageNo') : 1;\n      let pageCount = +(this.param('pageCount') || this.pageCount);\n\n\n      if (listOrder && !think.isEmpty(JSON.parse(listOrder))) {\n        listOrder = JSON.parse(listOrder);\n      } else {\n        listOrder = this.listOrder;\n      }\n\n      if (this.param('filter')) {\n        filter = think.extend(filter, JSON.parse(this.param('filter')));\n      }\n\n      let t = this.modelInstance;\n      if (this.join) {\n        t = t.join(this.join);\n      }\n      if (this.field) {\n        t = t.field(this.field);\n      }\n      t = t.where(filter)\n        .order(listOrder);\n\n      if (needPaging) {\n        t.order(listOrder).page(pageNo, pageCount)\n      }\n      data = await t.select();\n    }\n    return this.success(data);\n\n  }\n\n  async postAction() {\n\n    let data = this.post();\n    delete data[this.modelPk];\n    if (think.isEmpty(data)) {\n      return this.fail(\"data is empty\");\n    }\n    let user = await this.session('user');\n    if (!think.isEmpty(user)) {\n      data.user = user.id;\n      data.author = user.id;\n      data.publisher = user.id;\n    }\n\n    let insertId = await this.modelInstance.add(data);\n    return this.success({id: insertId});\n  }\n\n  async deleteAction() {\n\n    if (!this.id) {\n      return this.fail(\"params error\");\n    }\n    console.log(this.modelPk, ' delete');\n    let rows = await this.modelInstance.where({[this.modelPk]: this.id}).delete();\n    return this.success({affectedRows: rows});\n  }\n\n  async putAction() {\n\n    if (!this.id) {\n      return this.fail(\"params error\");\n    }\n    let data = this.post();\n    delete data[this.modelPk];\n    if (think.isEmpty(data)) {\n      return this.fail(\"data is empty\");\n    }\n    let rows = await this.modelInstance.where({[this.modelPk]: this.id}).update(data);\n    return this.success({affectedRows: rows});\n  }\n\n  /**\n   * @param obj the base object\n   * @param arr array of Object which desc popular key and collection name. for example:{key:'author',ref:'users'}\n   *\n   */\n  async populate(obj, arr) {\n    let model;\n    let key;\n    for (let i of arr) {\n      model = this.model(i.ref);\n      key = i.key;\n      if (think.isArray(obj[key])) {\n        for (let j of obj[key]) {\n          obj[key].push(await model.where({'_id': j + ''}).find());\n          obj[key].shift();\n        }\n      } else {\n        obj[key] = await model.where({'_id': obj[key] + ''}).find();\n      }\n\n    }\n    return obj;\n  }\n\n  async helper() {\n\n  }\n}"]}