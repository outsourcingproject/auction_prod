{"version":3,"sources":["../../../src/api/controller/ueditor.js"],"names":[],"mappings":"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","file":"ueditor.js","sourcesContent":["'use strict';\r\n\r\nimport Base from './base.js';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\n\r\nexport default class extends Base {\r\n  config;\r\n\r\n  init(...args) {\r\n    super.init(...args);\r\n  }\r\n\r\n  /**\r\n   * index action\r\n   * @return {Promise} []\r\n   */\r\n  async indexAction() {\r\n    //auto render template file index_index.html\r\n    this.config = this.config(\"ueditor\");\r\n    let action = this.get(\"action\");\r\n    think.log(action);\r\n    let result;\r\n    switch (action) {\r\n      case 'config':\r\n        result = this.config;\r\n\r\n        break;\r\n\r\n      /* 上传图片 */\r\n      case 'uploadimage':\r\n      /* 上传涂鸦 */\r\n      case 'uploadscrawl':\r\n      /* 上传视频 */\r\n      case 'uploadvideo':\r\n      /* 上传文件 */\r\n      case 'uploadfile':\r\n\r\n        result = this.uploads();\r\n        //console.log(result);\r\n        break;\r\n\r\n      /* 列出图片 */\r\n      case 'listimage':\r\n      /* 列出文件 */\r\n      case 'listfile':\r\n        result = this.uploadlist();\r\n        break;\r\n\r\n      /* 抓取远程文件 */\r\n      case 'catchimage':\r\n        result = await this.crawler();\r\n        break;\r\n\r\n      default:\r\n        result = {\r\n          state: '请求地址出错'\r\n        };\r\n\r\n        break;\r\n    }\r\n    //返回结果\r\n    this.jsonp(result);\r\n\r\n  }\r\n\r\n  uploads() {\r\n    /**\r\n     * 得到上传文件所对应的各个参数,数组结构\r\n     * obj={\r\n     *     \"state\" : \"\",          //上传状态，上传成功时必须返回\"SUCCESS\"\r\n     *     \"url\" : \"\",            //返回的地址\r\n     *     \"title\" : \"\",          //新文件名\r\n     *     \"original\" : \"\",       //原始文件名\r\n     *     \"type\" : \"\" ,           //文件类型\r\n     *     \"size\" : \"\",           //文件大小\r\n     * }\r\n     */\r\n    let action = this.get(\"action\");\r\n    let base64 = \"upload\";\r\n    let config = {};\r\n    let fieldName;\r\n\r\n    switch (action) {\r\n      case 'uploadimage':\r\n        config = {\r\n          pathFormat: this.config['imagePathFormat'],\r\n          maxSize: this.config['imageMaxSize'],\r\n          allowFiles: this.config['imageAllowFiles']\r\n        };\r\n        fieldName = this.config['imageFieldName'];\r\n        break;\r\n      case 'uploadscrawl':\r\n        config = {\r\n          \"pathFormat\": this.config['scrawlPathFormat'],\r\n          \"maxSize\": this.config['scrawlMaxSize'],\r\n          \"allowFiles\": this.config['scrawlAllowFiles'],\r\n          \"oriName\": \"scrawl.png\"\r\n        };\r\n        fieldName = this.config['scrawlFieldName'];\r\n        base64 = \"base64\";\r\n        break;\r\n      case 'uploadvideo':\r\n        config = {\r\n          \"pathFormat\": this.config['videoPathFormat'],\r\n          \"maxSize\": this.config['videoMaxSize'],\r\n          \"allowFiles\": this.config['videoAllowFiles']\r\n        };\r\n        fieldName = this.config['videoFieldName'];\r\n        break;\r\n      case 'uploadfile':\r\n      default:\r\n        config = {\r\n          \"pathFormat\": this.config['filePathFormat'],\r\n          \"maxSize\": this.config['fileMaxSize'],\r\n          \"allowFiles\": this.config['fileAllowFiles']\r\n        };\r\n        fieldName = this.config['fileFieldName'];\r\n        break;\r\n    }\r\n    //return self.uploader(fieldName, config, oriName, size, path, base64);\r\n    let up = think.adapter(\"editor\", \"ueditor\"); //加载名为 ueditor 的 editor Adapter\r\n    let upload = new up(fieldName, config, base64, this.http); //实例化 Adapter\r\n\r\n    return upload.getFileInfo();\r\n  }\r\n\r\n  //抓取远程图片\r\n  async crawler() {\r\n    /* 上传配置 */\r\n    let config = {\r\n      \"pathFormat\": this.config['catcherPathFormat'],\r\n      \"maxSize\": this.config['catcherMaxSize'],\r\n      \"allowFiles\": this.config['catcherAllowFiles'],\r\n      \"oriName\": \"remote.png\"\r\n    };\r\n    let fieldName = this.config['catcherFieldName'];\r\n    let source = this.post(fieldName + \"[]\");\r\n    if (think.isArray(source)) {\r\n      source = source;\r\n    } else {\r\n      source = [source];\r\n    }\r\n    let list = [];\r\n    for (let imgUrl of source) {\r\n      let up = think.adapter(\"editor\", \"ueditor\"); //加载名为 ueditor 的 editor Adapter\r\n      let upload = new up(imgUrl, config, \"remote\"); //实例化 Adapter\r\n      let info = await upload.saveRemote();\r\n      //console.log(info);\r\n      list.push({\r\n        \"state\": \"SUCCESS\",\r\n        \"url\": info.url,\r\n        \"size\": 431521,\r\n        \"title\": info.title,\r\n        \"original\": info.original,\r\n        \"source\": imgUrl\r\n      });\r\n    }\r\n    //console.log(think.isEmpty(list));\r\n    return {\r\n      state: !think.isEmpty(list) ? 'SUCCESS' : 'ERROR',\r\n      list: list\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取已上传的文件列表\r\n   */\r\n  uploadlist() {\r\n    var allowFiles, listSize, path;\r\n    //判断类型\r\n    switch (this.get(\"action\")) {\r\n      //列出文件\r\n      case 'listfile':\r\n        allowFiles = this.config['fileManagerAllowFiles'];\r\n        listSize = this.config['fileManagerListSize'];\r\n        path = this.config['fileManagerListPath'];\r\n        break;\r\n      //列出图片\r\n      case 'listimage':\r\n      default:\r\n        allowFiles = this.config['imageManagerAllowFiles'];\r\n        listSize = this.config['imageManagerListSize'];\r\n        path = this.config['imageManagerListPath'];\r\n    }\r\n    //allowFiles = allowFiles.join(\"\").replace(/[.]/g,\"|\").substr(1);\r\n    /* 获取参数 */\r\n    var size = this.get('size') ? this.get('size') : listSize;\r\n    var start = this.get('start') ? this.get('start') : 0;\r\n    var end = parseInt(size) + parseInt(start);\r\n    /* 获取文件列表 */\r\n    path = path.substr(0, path.lastIndexOf(\"/\"));\r\n    var files = this.scanFolder(path).files;\r\n    if (files.length == 0) {\r\n      return {\r\n        \"state\": \"no match file\",\r\n        \"list\": [],\r\n        \"start\": start,\r\n        \"total\": files.length\r\n      }\r\n    }\r\n    /* 获取指定范围的列表 */\r\n    var len = files.length;\r\n    var files_n = [];\r\n    for (let i = 0; i < len; i++) {\r\n      var t = files[i].substr(files[i].lastIndexOf(\".\")).toLocaleLowerCase();\r\n      if (allowFiles.includes(t)) {\r\n        files_n.push(files[i])\r\n      }\r\n    }\r\n\r\n    var lenn = files_n.length;\r\n    for (let i = Math.min(end, lenn) - 1, list = []; i < lenn && i >= 0 && i >= start; i--) {\r\n      var f = files_n[i];\r\n      list.push({url: f});\r\n    }\r\n\r\n    return {\r\n      \"state\": \"SUCCESS\",\r\n      \"list\": list,\r\n      \"start\": start,\r\n      \"total\": files.length\r\n    };\r\n\r\n  }\r\n\r\n  /**\r\n   * 遍历获取目录下的指定类型的文件\r\n   */\r\n  scanFolder(path) {\r\n    var fileList = [],\r\n      folderList = [],\r\n      walk = function (path, fileList, folderList) {\r\n        let files = fs.readdirSync(think.UPLOAD_PATH + \"/\" + path);\r\n        files.forEach(function (item) {\r\n          var tmpPath = path + '/' + item,\r\n            stats = fs.statSync(think.UPLOAD_PATH + \"/\" + tmpPath);\r\n\r\n          if (stats.isDirectory()) {\r\n            walk(tmpPath, fileList, folderList);\r\n            folderList.push(tmpPath);\r\n          } else {\r\n            fileList.push(tmpPath);\r\n          }\r\n        });\r\n      };\r\n\r\n    walk(path, fileList, folderList);\r\n\r\n    console.log('扫描' + path + '成功');\r\n\r\n    return {\r\n      'files': fileList,\r\n      'folders': folderList\r\n    }\r\n  }\r\n}\r\n"]}