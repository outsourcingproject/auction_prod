{"version":3,"sources":["../../../src/api/controller/ueditor.js"],"names":[],"mappings":"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","file":"ueditor.js","sourcesContent":["'use strict';\n\nimport Base from './base.js';\nimport fs from 'fs';\nimport path from 'path';\n\nexport default class extends Base {\n  config;\n\n  init(...args) {\n    super.init(...args);\n  }\n\n  /**\n   * index action\n   * @return {Promise} []\n   */\n  async indexAction() {\n    //auto render template file index_index.html\n    this.config = this.config(\"ueditor\");\n    let action = this.get(\"action\");\n    think.log(action);\n    let result;\n    switch (action) {\n      case 'config':\n        result = this.config;\n\n        break;\n\n      /* 上传图片 */\n      case 'uploadimage':\n      /* 上传涂鸦 */\n      case 'uploadscrawl':\n      /* 上传视频 */\n      case 'uploadvideo':\n      /* 上传文件 */\n      case 'uploadfile':\n\n        result = this.uploads();\n        //console.log(result);\n        break;\n\n      /* 列出图片 */\n      case 'listimage':\n      /* 列出文件 */\n      case 'listfile':\n        result = this.uploadlist();\n        break;\n\n      /* 抓取远程文件 */\n      case 'catchimage':\n        result = await this.crawler();\n        break;\n\n      default:\n        result = {\n          state: '请求地址出错'\n        };\n\n        break;\n    }\n    //返回结果\n    this.jsonp(result);\n\n  }\n\n  uploads() {\n    /**\n     * 得到上传文件所对应的各个参数,数组结构\n     * obj={\n     *     \"state\" : \"\",          //上传状态，上传成功时必须返回\"SUCCESS\"\n     *     \"url\" : \"\",            //返回的地址\n     *     \"title\" : \"\",          //新文件名\n     *     \"original\" : \"\",       //原始文件名\n     *     \"type\" : \"\" ,           //文件类型\n     *     \"size\" : \"\",           //文件大小\n     * }\n     */\n    let action = this.get(\"action\");\n    let base64 = \"upload\";\n    let config = {};\n    let fieldName;\n\n    switch (action) {\n      case 'uploadimage':\n        config = {\n          pathFormat: this.config['imagePathFormat'],\n          maxSize: this.config['imageMaxSize'],\n          allowFiles: this.config['imageAllowFiles']\n        };\n        fieldName = this.config['imageFieldName'];\n        break;\n      case 'uploadscrawl':\n        config = {\n          \"pathFormat\": this.config['scrawlPathFormat'],\n          \"maxSize\": this.config['scrawlMaxSize'],\n          \"allowFiles\": this.config['scrawlAllowFiles'],\n          \"oriName\": \"scrawl.png\"\n        };\n        fieldName = this.config['scrawlFieldName'];\n        base64 = \"base64\";\n        break;\n      case 'uploadvideo':\n        config = {\n          \"pathFormat\": this.config['videoPathFormat'],\n          \"maxSize\": this.config['videoMaxSize'],\n          \"allowFiles\": this.config['videoAllowFiles']\n        };\n        fieldName = this.config['videoFieldName'];\n        break;\n      case 'uploadfile':\n      default:\n        config = {\n          \"pathFormat\": this.config['filePathFormat'],\n          \"maxSize\": this.config['fileMaxSize'],\n          \"allowFiles\": this.config['fileAllowFiles']\n        };\n        fieldName = this.config['fileFieldName'];\n        break;\n    }\n    //return self.uploader(fieldName, config, oriName, size, path, base64);\n    let up = think.adapter(\"editor\", \"ueditor\"); //加载名为 ueditor 的 editor Adapter\n    let upload = new up(fieldName, config, base64, this.http); //实例化 Adapter\n\n    return upload.getFileInfo();\n  }\n\n  //抓取远程图片\n  async crawler() {\n    /* 上传配置 */\n    let config = {\n      \"pathFormat\": this.config['catcherPathFormat'],\n      \"maxSize\": this.config['catcherMaxSize'],\n      \"allowFiles\": this.config['catcherAllowFiles'],\n      \"oriName\": \"remote.png\"\n    };\n    let fieldName = this.config['catcherFieldName'];\n    let source = this.post(fieldName + \"[]\");\n    if (think.isArray(source)) {\n      source = source;\n    } else {\n      source = [source];\n    }\n    let list = [];\n    for (let imgUrl of source) {\n      let up = think.adapter(\"editor\", \"ueditor\"); //加载名为 ueditor 的 editor Adapter\n      let upload = new up(imgUrl, config, \"remote\"); //实例化 Adapter\n      let info = await upload.saveRemote();\n      //console.log(info);\n      list.push({\n        \"state\": \"SUCCESS\",\n        \"url\": info.url,\n        \"size\": 431521,\n        \"title\": info.title,\n        \"original\": info.original,\n        \"source\": imgUrl\n      });\n    }\n    //console.log(think.isEmpty(list));\n    return {\n      state: !think.isEmpty(list) ? 'SUCCESS' : 'ERROR',\n      list: list\n    }\n  }\n\n  /**\n   * 获取已上传的文件列表\n   */\n  uploadlist() {\n    var allowFiles, listSize, path;\n    //判断类型\n    switch (this.get(\"action\")) {\n      //列出文件\n      case 'listfile':\n        allowFiles = this.config['fileManagerAllowFiles'];\n        listSize = this.config['fileManagerListSize'];\n        path = this.config['fileManagerListPath'];\n        break;\n      //列出图片\n      case 'listimage':\n      default:\n        allowFiles = this.config['imageManagerAllowFiles'];\n        listSize = this.config['imageManagerListSize'];\n        path = this.config['imageManagerListPath'];\n    }\n    //allowFiles = allowFiles.join(\"\").replace(/[.]/g,\"|\").substr(1);\n    /* 获取参数 */\n    var size = this.get('size') ? this.get('size') : listSize;\n    var start = this.get('start') ? this.get('start') : 0;\n    var end = parseInt(size) + parseInt(start);\n    /* 获取文件列表 */\n    path = path.substr(0, path.lastIndexOf(\"/\"));\n    var files = this.scanFolder(path).files;\n    if (files.length == 0) {\n      return {\n        \"state\": \"no match file\",\n        \"list\": [],\n        \"start\": start,\n        \"total\": files.length\n      }\n    }\n    /* 获取指定范围的列表 */\n    var len = files.length;\n    var files_n = [];\n    for (let i = 0; i < len; i++) {\n      var t = files[i].substr(files[i].lastIndexOf(\".\")).toLocaleLowerCase();\n      if (allowFiles.includes(t)) {\n        files_n.push(files[i])\n      }\n    }\n\n    var lenn = files_n.length;\n    for (let i = Math.min(end, lenn) - 1, list = []; i < lenn && i >= 0 && i >= start; i--) {\n      var f = files_n[i];\n      list.push({url: f});\n    }\n\n    return {\n      \"state\": \"SUCCESS\",\n      \"list\": list,\n      \"start\": start,\n      \"total\": files.length\n    };\n\n  }\n\n  /**\n   * 遍历获取目录下的指定类型的文件\n   */\n  scanFolder(path) {\n    var fileList = [],\n      folderList = [],\n      walk = function (path, fileList, folderList) {\n        let files = fs.readdirSync(think.UPLOAD_PATH + \"/\" + path);\n        files.forEach(function (item) {\n          var tmpPath = path + '/' + item,\n            stats = fs.statSync(think.UPLOAD_PATH + \"/\" + tmpPath);\n\n          if (stats.isDirectory()) {\n            walk(tmpPath, fileList, folderList);\n            folderList.push(tmpPath);\n          } else {\n            fileList.push(tmpPath);\n          }\n        });\n      };\n\n    walk(path, fileList, folderList);\n\n    console.log('扫描' + path + '成功');\n\n    return {\n      'files': fileList,\n      'folders': folderList\n    }\n  }\n}\n"]}