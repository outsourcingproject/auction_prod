{"version":3,"sources":["../../../src/api/controller/item.js"],"names":[],"mappings":"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","file":"item.js","sourcesContent":["'use strict';\r\n\r\nimport Base from './base.js';\r\n\r\nexport default class extends Base {\r\n  /**\r\n   * index action\r\n   * @return {Promise} []\r\n   */\r\n  init(...args) {\r\n    super.init(...args);\r\n    this.itemModel = this.model('item');\r\n  }\r\n\r\n  async auctioningAction() {\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n      .setRelation(false)\r\n      .where({status: itemModel.AUCTIONING})\r\n      .join(\"item_type on item.type = item_type.id\")\r\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, image, item_type.name as type\")\r\n      .select();\r\n    let user = await this.session(\"user\");\r\n    if (!think.isEmpty(user)) {\r\n      let followingItems = await this.model(\"follow\").field(\"item\").where({user: user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=> {\r\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\r\n      });\r\n    } else {\r\n      items.map((i)=> {\r\n        return i[\"following\"] = null\r\n      });\r\n    }\r\n    return this.success(items);\r\n  }\r\n\r\n  async auctionedAction() {\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n      .setRelation(false)\r\n      .where({status: itemModel.AUCTION_ENDED})\r\n      .join(\"item_type on item.type = item_type.id\")\r\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, image, item_type.name as type\")\r\n      .select();\r\n    let user = await this.session(\"user\");\r\n    if (!think.isEmpty(user)) {\r\n      let followingItems = await this.model(\"follow\").field(\"item\").where({user: user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=> {\r\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\r\n      });\r\n    } else {\r\n      items.map((i)=> {\r\n        return i[\"following\"] = null\r\n      });\r\n    }\r\n    return this.success(items);\r\n  }\r\n\r\n  async auctionNotStartAction() {\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n      .setRelation(false)\r\n      .where({status: itemModel.AUCTION_NOT_STARTED})\r\n      .join(\"item_type on item.type = item_type.id\")\r\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, image, item_type.name as type\")\r\n      .select();\r\n    let user = await this.session(\"user\");\r\n    if (!think.isEmpty(user)) {\r\n      let followingItems = await this.model(\"follow\").field(\"item\").where({user: user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=> {\r\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\r\n      });\r\n    } else {\r\n      items.map((i)=> {\r\n        return i[\"following\"] = null\r\n      });\r\n    }\r\n    return this.success(items);\r\n\r\n  }\r\n\r\n  //返回某个拍品的所有竞拍记录\r\n  async getBidAction() {\r\n    let itemId = this.param(\"id\");\r\n    let res = await this.model(\"bid\").getItemBids(itemId);\r\n    return this.success(res);\r\n  }\r\n\r\n  //竞拍某样物品\r\n  //传入参数 auctionPrice：竞拍价格，itemId: 竞拍物品；\r\n  async bidAction() {\r\n    let now = +new Date();\r\n\r\n    let config = think.model('config', null, 'api');\r\n\r\n    let user = await this.session(\"user\");\r\n    if (think.isEmpty(user))\r\n      return this.fail();\r\n    let userId = user[\"id\"];\r\n    let value = this.param(\"auctionPrice\");\r\n    let itemid = this.param(\"itemId\");\r\n    let res = await this.model(\"bid\").addOne({\r\n      user: userId,\r\n      item: itemid,\r\n      value: value,\r\n      status: this.model(\"bid\").LEADING\r\n    });//res=0 if failed\r\n    //将新的价格数据返回给前端。\r\n    let item = await this.model(\"item\").setRelation(false).where({id: itemid}).find();\r\n\r\n\r\n    //时间领先\r\n    if (item.auctionType == 0) {\r\n      let time = config.get('auction.ahead_time.time');\r\n\r\n      if (item.auctionEndTime < now + time) {\r\n        item.auctionEndTime = now + time;\r\n        await this.model(\"item\").where({id: itemid}).update({auctionEndTime: item.auctionEndTime});\r\n        this.model(\"item\").setCheckStatusTimer(item.auctionEndTime - now);\r\n      }\r\n    }\r\n    //固定时间\r\n    else if (item.auctionType == 1) {\r\n      let need_delay_time = config.get('auction.fix_time.need_delay_time');\r\n      let auto_delay_time = config.get('auction.fix_time.auto_delay_time');\r\n      if (now + need_delay_time > item.auctionEndTime) {\r\n        item.auctionEndTime += auto_delay_time;\r\n        await this.model(\"item\").where({id: itemid}).update({auctionEndTime: item.auctionEndTime});\r\n        this.model(\"item\").setCheckStatusTimer(item.auctionEndTime - now);\r\n      }\r\n    }\r\n    let newStage = await this.model(\"item\").getStage(item[\"currentPrice\"]);\r\n    return this.success({id: res, newPrice: item[\"currentPrice\"], newStage: newStage});\r\n  }\r\n\r\n  async followAction() {\r\n    let user = await this.session(\"user\");\r\n    if (think.isEmpty(user))\r\n      return this.fail();\r\n    let userId = user.id;\r\n    let itemId = this.param(\"itemId\");\r\n    let state = this.param(\"state\");\r\n    if (state)\r\n      return this.success(await this.model(\"follow\").add({user: userId, item: itemId}));\r\n    else\r\n      return this.success(await this.model(\"follow\").where({user: userId, item: itemId}).delete());\r\n  }\r\n\r\n  async groupAction() {\r\n    let groupId = this.param(\"id\");\r\n    let data = await this.model(\"item_group\").selectData(groupId);\r\n    return this.success(data);\r\n  }\r\n\r\n  async detailAction() {\r\n    let itemId = this.param(\"id\"); //获取item id;\r\n    let resItemInfo = await this._detailHelper(itemId);\r\n    let resRelatedItems = await this._relatedItemHelper(itemId);\r\n    let user = await this.session(\"user\");\r\n    if (!think.isEmpty(user)) {\r\n      let userId = user[\"id\"];\r\n      resItemInfo[\"following\"] = await this._followingHelper(userId, itemId);\r\n      for (let r of resRelatedItems)\r\n        r[\"following\"] = await this._followingHelper(userId, r[\"id\"]);\r\n    } else {\r\n      resItemInfo[\"following\"] = null;\r\n      for (let r of resRelatedItems)\r\n        r[\"following\"] = null;\r\n    }\r\n    resItemInfo[\"relatedItems\"] = resRelatedItems;\r\n    return this.success(resItemInfo);\r\n  }\r\n\r\n  async _relatedItemHelper(id, userId) {\r\n    let itemInfo = await this.itemModel.setRelation(false).where({\"id\": id}).find();\r\n    let relatedItems = await this.itemModel.setRelation(false).where({\"group\": itemInfo[\"group\"]}).field(\"id\").limit(10).select();\r\n    let res = [];\r\n    for (let r of relatedItems) {\r\n      let rDetail = await this._detailHelper(r[\"id\"], userId);\r\n      res.push(rDetail);\r\n    }\r\n    return res;\r\n\r\n  }\r\n\r\n  async _detailHelper(id) {\r\n    let itemInfo = await this.itemModel.setRelation(false).where({\"id\": id}).find();\r\n    let imageIds = JSON.parse(itemInfo[\"image\"]);\r\n    itemInfo[\"bidCount\"] = await this.model(\"bid\").where({\"item\": id}).count();\r\n    itemInfo[\"followCount\"] = await this.model(\"follow\").where({\"item\": id}).count();\r\n    itemInfo.beginPrice = +itemInfo.beginPrice;\r\n    itemInfo.currentPrice = +itemInfo.currentPrice;\r\n    itemInfo[\"stage\"] = await this.model(\"item\").getStage(itemInfo[\"currentPrice\"]);\r\n    return itemInfo;\r\n  }\r\n\r\n  async _followingHelper(userId, itemId) {\r\n    return await this.model(\"follow\").isFollowing(userId, itemId);\r\n  }\r\n}"]}