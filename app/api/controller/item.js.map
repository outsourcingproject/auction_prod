{"version":3,"sources":["../../../src/api/controller/item.js"],"names":[],"mappings":"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","file":"item.js","sourcesContent":["'use strict';\n\nimport Base from './base.js';\n\nexport default class extends Base {\n  /**\n   * index action\n   * @return {Promise} []\n   */\n  init(...args) {\n    super.init(...args);\n    this.itemModel = this.model('item');\n  }\n\n  async auctioningAction() {\n    let itemModel = this.model(\"item\");\n    let items = await this.model(\"item\")\n      .setRelation(false)\n      .join(\"item_group on item.group = item_group.id\")\n      .join(\"item_type on item.type = item_type.id\")\n      .where({ status: itemModel.AUCTIONING })\n      .where(\"item_group.isOpen = 1\")\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, item.image, item_type.name as type\")\n      .select();\n    let user = await this.session(\"user\");\n    if (!think.isEmpty(user)) {\n      let followingItems = await this.model(\"follow\").field(\"item\").where({ user: user[\"id\"] }).select();\n      let itemIds = followingItems.map((f) => f[\"item\"]);\n      items.map((i) => {\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\n      });\n    } else {\n      items.map((i) => {\n        return i[\"following\"] = null\n      });\n    }\n    return this.success(items);\n  }\n\n  async auctionedAction() {\n    let itemModel = this.model(\"item\");\n    let items = await this.model(\"item\")\n      .setRelation(false)\n      .join(\"item_group on item.group = item_group.id\")\n      .join(\"item_type on item.type = item_type.id\")\n      .where({ status: [itemModel.AUCTION_ENDED, itemModel.AUCTION_FAILED] })\n      .where(\"item_group.isOpen = 1\")\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, item.image, item_type.name as type\")\n      .select();\n    let user = await this.session(\"user\");\n    if (!think.isEmpty(user)) {\n      let followingItems = await this.model(\"follow\").field(\"item\").where({ user: user[\"id\"] }).select();\n      let itemIds = followingItems.map((f) => f[\"item\"]);\n      items.map((i) => {\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\n      });\n    } else {\n      items.map((i) => {\n        return i[\"following\"] = null\n      });\n    }\n    return this.success(items);\n  }\n\n  async auctionNotStartAction() {\n    let itemModel = this.model(\"item\");\n    let items = await this.model(\"item\")\n      .setRelation(false)\n      .join(\"item_group on item.group = item_group.id\")\n      .join(\"item_type on item.type = item_type.id\")\n      .where({ status: itemModel.AUCTION_NOT_STARTED })\n      .where(\"item_group.isOpen = 1\")\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, item.image, item_type.name as type\")\n      .select();\n    let user = await this.session(\"user\");\n    if (!think.isEmpty(user)) {\n      let followingItems = await this.model(\"follow\").field(\"item\").where({ user: user[\"id\"] }).select();\n      let itemIds = followingItems.map((f) => f[\"item\"]);\n      items.map((i) => {\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\n      });\n    } else {\n      items.map((i) => {\n        return i[\"following\"] = null\n      });\n    }\n    return this.success(items);\n\n  }\n\n  //返回某个拍品的所有竞拍记录\n  async getBidAction() {\n    let itemId = this.param(\"id\");\n    let res = await this.model(\"bid\").getItemBids(itemId);\n    return this.success(res);\n  }\n\n  //竞拍某样物品\n  //传入参数 auctionPrice：竞拍价格，itemId: 竞拍物品；\n  async bidAction() {\n    let now = +new Date();\n\n    let config = think.model('config', null, 'api');\n\n    let user = await this.session(\"user\");\n    if (think.isEmpty(user))\n      return this.fail();\n    let userId = user[\"id\"];\n    let value = this.param(\"auctionPrice\");\n    let itemid = this.param(\"itemId\");\n    let res = await this.model(\"bid\").addOne({\n      user: userId,\n      item: itemid,\n      value: value,\n      status: this.model(\"bid\").LEADING\n    });\n    await this.model(\"item\").where({ id: itemid }).update({\n      currentBidder: userId\n    });\n\n    user = await this.model(\"user\").where({ id: userId}).find()\n    await this.model(\"user\").where({ id:userId }).update({\n      remainCreditLines: user.remainCreditLines - value \n    })\n    //将新的价格数据返回给前端。\n    let item = await this.model(\"item\").setRelation(false).where({ id: itemid }).find();\n\n\n    //时间领先\n    if (item.auctionType == 0) {\n      let time = config.get('auction.ahead_time.time');\n\n      if (item.auctionEndTime < now + time) {\n        item.auctionEndTime = now + time;\n        await this.model(\"item\").where({ id: itemid }).update({\n          auctionEndTime: item.auctionEndTime\n        });\n        this.model(\"item\").setCheckStatusTimer(item.auctionEndTime - now);\n      }\n    }\n    //固定时间\n    else if (item.auctionType == 1) {\n      let need_delay_time = config.get('auction.fix_time.need_delay_time');\n      let auto_delay_time = config.get('auction.fix_time.auto_delay_time');\n      if (now + need_delay_time > item.auctionEndTime) {\n        item.auctionEndTime += auto_delay_time;\n        await this.model(\"item\").where({ id: itemid }).update({\n          auctionEndTime: item.auctionEndTime\n        });\n        this.model(\"item\").setCheckStatusTimer(item.auctionEndTime - now);\n      }\n    }\n    let newStage = await this.model(\"item\").getStage(item[\"currentPrice\"]);\n    return this.success({ id: res, newPrice: item[\"currentPrice\"], newStage: newStage });\n  }\n\n  async followAction() {\n    let user = await this.session(\"user\");\n    if (think.isEmpty(user))\n      return this.fail();\n    let userId = user.id;\n    let itemId = this.param(\"itemId\");\n    let state = this.param(\"state\");\n    if (state)\n      return this.success(await this.model(\"follow\").add({ user: userId, item: itemId }));\n    else\n      return this.success(await this.model(\"follow\").where({ user: userId, item: itemId }).delete());\n  }\n\n  async groupAction() {\n    let groupId = this.param(\"id\");\n    let group = await this.model(\"item_group\").selectData(groupId);\n    let data = await this.model(\"item\")\n      .setRelation(false)\n      .join(\"item_group on item.group = item_group.id\")\n      .join(\"item_type on item.type = item_type.id\")\n      .where({ \"item_group.id\": groupId })\n      .where(\"item_group.isOpen = 1\")\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, item.image, item_type.name as type\")\n      .select();\n    return this.success({ group, items: data });\n  }\n\n  async detailAction() {\n    let itemId = this.param(\"id\"); //获取item id;\n    let resItemInfo = await this._detailHelper(itemId);\n    let resRelatedItems = await this._relatedItemHelper(itemId);\n    let user = await this.session(\"user\");\n    if (!think.isEmpty(user)) {\n      let userId = user[\"id\"];\n      resItemInfo[\"following\"] = await this._followingHelper(userId, itemId);\n      for (let r of resRelatedItems)\n        r[\"following\"] = await this._followingHelper(userId, r[\"id\"]);\n    } else {\n      resItemInfo[\"following\"] = null;\n      for (let r of resRelatedItems)\n        r[\"following\"] = null;\n    }\n    resItemInfo[\"relatedItems\"] = resRelatedItems;\n    return this.success(resItemInfo);\n  }\n\n  async _relatedItemHelper(id, userId) {\n    let itemInfo = await this.itemModel.setRelation(false).where({ \"id\": id }).find();\n    let relatedItems = await this.itemModel.setRelation(false).where({ \"group\": itemInfo[\"group\"] }).field(\"id\").limit(10).select();\n    let res = [];\n    for (let r of relatedItems) {\n      let rDetail = await this._detailHelper(r[\"id\"], userId);\n      res.push(rDetail);\n    }\n    return res;\n\n  }\n\n  async _detailHelper(id) {\n    let itemInfo = await this.itemModel.setRelation(false).where({ \"id\": id }).find();\n    let imageIds = JSON.parse(itemInfo[\"image\"]);\n    itemInfo[\"bidCount\"] = await this.model(\"bid\").where({ \"item\": id }).count();\n    itemInfo[\"followCount\"] = await this.model(\"follow\").where({ \"item\": id }).count();\n    itemInfo.beginPrice = +itemInfo.beginPrice;\n    itemInfo.currentPrice = +itemInfo.currentPrice;\n    itemInfo[\"stage\"] = await this.model(\"item\").getStage(itemInfo[\"currentPrice\"]);\n    return itemInfo;\n  }\n\n  async _followingHelper(userId, itemId) {\n    return await this.model(\"follow\").isFollowing(userId, itemId);\n  }\n}"]}