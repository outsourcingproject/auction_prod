{"version":3,"sources":["../../../src/api/controller/item.js"],"names":["init","args","itemModel","model","auctioningAction","setRelation","join","where","status","AUCTIONING","field","select","items","session","user","think","isEmpty","followingItems","itemIds","map","f","i","indexOf","success","auctionedAction","AUCTION_ENDED","AUCTION_FAILED","auctionNotStartAction","AUCTION_NOT_STARTED","getBidAction","itemId","param","getItemBids","res","bidAction","now","Date","config","fail","userId","value","itemid","addOne","item","LEADING","id","find","auctionType","time","get","auctionEndTime","update","setCheckStatusTimer","need_delay_time","auto_delay_time","getStage","newStage","newPrice","followAction","state","add","delete","groupAction","groupId","selectData","group","data","detailAction","_detailHelper","resItemInfo","_relatedItemHelper","resRelatedItems","_followingHelper","r","itemInfo","limit","relatedItems","rDetail","push","imageIds","JSON","parse","count","beginPrice","currentPrice","isFollowing"],"mappings":"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","file":"item.js","sourcesContent":["'use strict';\r\n\r\nimport Base from './base.js';\r\n\r\nexport default class extends Base {\r\n  /**\r\n   * index action\r\n   * @return {Promise} []\r\n   */\r\n  init(...args) {\r\n    super.init(...args);\r\n    this.itemModel = this.model('item');\r\n  }\r\n\r\n  async auctioningAction() {\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n      .setRelation(false)\r\n      .join(\"item_group on item.group = item_group.id\")\r\n      .join(\"item_type on item.type = item_type.id\")\r\n      .where({status: itemModel.AUCTIONING})\r\n      .where(\"item_group.isOpen = 1\")\r\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, item.image, item_type.name as type\")\r\n      .select();\r\n    let user = await this.session(\"user\");\r\n    if (!think.isEmpty(user)) {\r\n      let followingItems = await this.model(\"follow\").field(\"item\").where({user: user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=> {\r\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\r\n      });\r\n    } else {\r\n      items.map((i)=> {\r\n        return i[\"following\"] = null\r\n      });\r\n    }\r\n    return this.success(items);\r\n  }\r\n\r\n  async auctionedAction() {\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n      .setRelation(false)\r\n      .join(\"item_group on item.group = item_group.id\")\r\n      .join(\"item_type on item.type = item_type.id\")\r\n      .where({status: [itemModel.AUCTION_ENDED, itemModel.AUCTION_FAILED]})\r\n      .where(\"item_group.isOpen = 1\")\r\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, item.image, item_type.name as type\")\r\n      .select();\r\n    let user = await this.session(\"user\");\r\n    if (!think.isEmpty(user)) {\r\n      let followingItems = await this.model(\"follow\").field(\"item\").where({user: user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=> {\r\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\r\n      });\r\n    } else {\r\n      items.map((i)=> {\r\n        return i[\"following\"] = null\r\n      });\r\n    }\r\n    return this.success(items);\r\n  }\r\n\r\n  async auctionNotStartAction() {\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n      .setRelation(false)\r\n      .join(\"item_group on item.group = item_group.id\")\r\n      .join(\"item_type on item.type = item_type.id\")\r\n      .where({status: itemModel.AUCTION_NOT_STARTED})\r\n      .where(\"item_group.isOpen = 1\")\r\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, item.image, item_type.name as type\")\r\n      .select();\r\n    let user = await this.session(\"user\");\r\n    if (!think.isEmpty(user)) {\r\n      let followingItems = await this.model(\"follow\").field(\"item\").where({user: user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=> {\r\n        return (itemIds.indexOf(i[\"id\"]) !== -1) ? i[\"following\"] = true : i[\"following\"] = false\r\n      });\r\n    } else {\r\n      items.map((i)=> {\r\n        return i[\"following\"] = null\r\n      });\r\n    }\r\n    return this.success(items);\r\n\r\n  }\r\n\r\n  //返回某个拍品的所有竞拍记录\r\n  async getBidAction() {\r\n    let itemId = this.param(\"id\");\r\n    let res = await this.model(\"bid\").getItemBids(itemId);\r\n    return this.success(res);\r\n  }\r\n\r\n  //竞拍某样物品\r\n  //传入参数 auctionPrice：竞拍价格，itemId: 竞拍物品；\r\n  async bidAction() {\r\n    let now = +new Date();\r\n\r\n    let config = think.model('config', null, 'api');\r\n\r\n    let user = await this.session(\"user\");\r\n    if (think.isEmpty(user))\r\n      return this.fail();\r\n    let userId = user[\"id\"];\r\n    let value = this.param(\"auctionPrice\");\r\n    let itemid = this.param(\"itemId\");\r\n    let res = await this.model(\"bid\").addOne({\r\n      user: userId,\r\n      item: itemid,\r\n      value: value,\r\n      status: this.model(\"bid\").LEADING\r\n    });//res=0 if failed\r\n    //将新的价格数据返回给前端。\r\n    let item = await this.model(\"item\").setRelation(false).where({id: itemid}).find();\r\n\r\n\r\n    //时间领先\r\n    if (item.auctionType == 0) {\r\n      let time = config.get('auction.ahead_time.time');\r\n\r\n      if (item.auctionEndTime < now + time) {\r\n        item.auctionEndTime = now + time;\r\n        await this.model(\"item\").where({id: itemid}).update({auctionEndTime: item.auctionEndTime});\r\n        this.model(\"item\").setCheckStatusTimer(item.auctionEndTime - now);\r\n      }\r\n    }\r\n    //固定时间\r\n    else if (item.auctionType == 1) {\r\n      let need_delay_time = config.get('auction.fix_time.need_delay_time');\r\n      let auto_delay_time = config.get('auction.fix_time.auto_delay_time');\r\n      if (now + need_delay_time > item.auctionEndTime) {\r\n        item.auctionEndTime += auto_delay_time;\r\n        await this.model(\"item\").where({id: itemid}).update({auctionEndTime: item.auctionEndTime});\r\n        this.model(\"item\").setCheckStatusTimer(item.auctionEndTime - now);\r\n      }\r\n    }\r\n    let newStage = await this.model(\"item\").getStage(item[\"currentPrice\"]);\r\n    return this.success({id: res, newPrice: item[\"currentPrice\"], newStage: newStage});\r\n  }\r\n\r\n  async followAction() {\r\n    let user = await this.session(\"user\");\r\n    if (think.isEmpty(user))\r\n      return this.fail();\r\n    let userId = user.id;\r\n    let itemId = this.param(\"itemId\");\r\n    let state = this.param(\"state\");\r\n    if (state)\r\n      return this.success(await this.model(\"follow\").add({user: userId, item: itemId}));\r\n    else\r\n      return this.success(await this.model(\"follow\").where({user: userId, item: itemId}).delete());\r\n  }\r\n\r\n  async groupAction() {\r\n    let groupId = this.param(\"id\");\r\n    let group = await this.model(\"item_group\").selectData(groupId);\r\n    let data = await this.model(\"item\")\r\n      .setRelation(false)\r\n      .join(\"item_group on item.group = item_group.id\")\r\n      .join(\"item_type on item.type = item_type.id\")\r\n      .where({\"item_group.id\": groupId})\r\n      .where(\"item_group.isOpen = 1\")\r\n      .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, item.image, item_type.name as type\")\r\n      .select();\r\n    return this.success({group,items:data});\r\n  }\r\n\r\n  async detailAction() {\r\n    let itemId = this.param(\"id\"); //获取item id;\r\n    let resItemInfo = await this._detailHelper(itemId);\r\n    let resRelatedItems = await this._relatedItemHelper(itemId);\r\n    let user = await this.session(\"user\");\r\n    if (!think.isEmpty(user)) {\r\n      let userId = user[\"id\"];\r\n      resItemInfo[\"following\"] = await this._followingHelper(userId, itemId);\r\n      for (let r of resRelatedItems)\r\n        r[\"following\"] = await this._followingHelper(userId, r[\"id\"]);\r\n    } else {\r\n      resItemInfo[\"following\"] = null;\r\n      for (let r of resRelatedItems)\r\n        r[\"following\"] = null;\r\n    }\r\n    resItemInfo[\"relatedItems\"] = resRelatedItems;\r\n    return this.success(resItemInfo);\r\n  }\r\n\r\n  async _relatedItemHelper(id, userId) {\r\n    let itemInfo = await this.itemModel.setRelation(false).where({\"id\": id}).find();\r\n    let relatedItems = await this.itemModel.setRelation(false).where({\"group\": itemInfo[\"group\"]}).field(\"id\").limit(10).select();\r\n    let res = [];\r\n    for (let r of relatedItems) {\r\n      let rDetail = await this._detailHelper(r[\"id\"], userId);\r\n      res.push(rDetail);\r\n    }\r\n    return res;\r\n\r\n  }\r\n\r\n  async _detailHelper(id) {\r\n    let itemInfo = await this.itemModel.setRelation(false).where({\"id\": id}).find();\r\n    let imageIds = JSON.parse(itemInfo[\"image\"]);\r\n    itemInfo[\"bidCount\"] = await this.model(\"bid\").where({\"item\": id}).count();\r\n    itemInfo[\"followCount\"] = await this.model(\"follow\").where({\"item\": id}).count();\r\n    itemInfo.beginPrice = +itemInfo.beginPrice;\r\n    itemInfo.currentPrice = +itemInfo.currentPrice;\r\n    itemInfo[\"stage\"] = await this.model(\"item\").getStage(itemInfo[\"currentPrice\"]);\r\n    return itemInfo;\r\n  }\r\n\r\n  async _followingHelper(userId, itemId) {\r\n    return await this.model(\"follow\").isFollowing(userId, itemId);\r\n  }\r\n}"]}