{"version":3,"sources":["../../../src/api/controller/item.js"],"names":[],"mappings":"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","file":"item.js","sourcesContent":["'use strict';\r\n\r\nimport Base from './base.js';\r\n\r\nexport default class extends Base {\r\n  /**\r\n   * index action\r\n   * @return {Promise} []\r\n   */\r\n  init(...args) {\r\n    super.init(...args);\r\n    this.itemModel = this.model('item');\r\n  }\r\n\r\n  async auctioningAction(){\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n          .setRelation(false)\r\n          .where({status:itemModel.AUCTIONING})\r\n          .join(\"item_type on item.type = item_type.id\")\r\n          .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, image, item_type.name as type\")\r\n          .limit(10)\r\n          .select();\r\n    let user = await this.session(\"user\");\r\n    if(!think.isEmpty(user)){ \r\n      let followingItems =await this.model(\"follow\").field(\"item\").where({user:user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=>{return (itemIds.indexOf(i[\"id\"])!==-1)?i[\"following\"]=true:i[\"following\"]=false});\r\n    }else{\r\n      items.map((i)=>{return i[\"following\"] = null});\r\n    }\r\n    return this.success(items);\r\n  }\r\n\r\n  async auctionedAction(){\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n          .setRelation(false)\r\n          .where({status:itemModel.AUCTION_ENDED})\r\n          .join(\"item_type on item.type = item_type.id\")\r\n          .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, image, item_type.name as type\")          \r\n          .limit(10)\r\n          .select();\r\n    let user = await this.session(\"user\");\r\n    if(!think.isEmpty(user)){ \r\n      let followingItems =await this.model(\"follow\").field(\"item\").where({user:user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=>{return (itemIds.indexOf(i[\"id\"])!==-1)?i[\"following\"]=true:i[\"following\"]=false});\r\n    }else{\r\n      items.map((i)=>{return i[\"following\"] = null});\r\n    }\r\n    return this.success(items);\r\n  }\r\n\r\n  async auctionNotStartAction(){\r\n    let itemModel = this.model(\"item\");\r\n    let items = await this.model(\"item\")\r\n          .setRelation(false)\r\n          .where({status:itemModel.AUCTION_NOT_STARTED })\r\n          .join(\"item_type on item.type = item_type.id\")\r\n          .field(\"item.id as id, currentPrice, item.name as name, followCount, auctionEndTime, image, item_type.name as type\")          \r\n          .limit(10)\r\n          .select();\r\n    let user = await this.session(\"user\");\r\n    if(!think.isEmpty(user)){ \r\n      let followingItems =await this.model(\"follow\").field(\"item\").where({user:user[\"id\"]}).select();\r\n      let itemIds = followingItems.map((f)=>f[\"item\"]);\r\n      items.map((i)=>{return (itemIds.indexOf(i[\"id\"])!==-1)?i[\"following\"]=true:i[\"following\"]=false});\r\n    }else{\r\n      items.map((i)=>{return i[\"following\"] = null});\r\n    }\r\n    return this.success(items);\r\n\r\n  }\r\n\r\n  //返回某个拍品的所有竞拍记录\r\n  async getBidAction(){\r\n    let itemId = this.param(\"id\");\r\n    let res = await this.model(\"bid\").getItemBids(itemId);\r\n    return this.success(res);\r\n  }\r\n\r\n  //竞拍某样物品\r\n  //传入参数 auctionPrice：竞拍价格，itemId: 竞拍物品；\r\n  async bidAction(){\r\n    let user = await this.session(\"user\");\r\n    if(think.isEmpty(user))\r\n      return this.fail();\r\n    let userId = user[\"id\"];\r\n    let value = this.param(\"auctionPrice\");\r\n    let item = this.param(\"itemId\");\r\n    let res = await this.model(\"bid\").addOne({user:userId, item:item, value:value, status:this.model(\"bid\").LEADING});//res=0 if failed\r\n    //将新的价格数据返回给前端。\r\n    let newPrice = await this.model(\"item\").setRelation(false).where({id:item}).field(\"currentPrice\").find();\r\n    let newStage = await this.model(\"item\").getStage(newPrice[\"currentPrice\"]);\r\n    return this.success({id:res, newPrice: newPrice[\"currentPrice\"], newStage: newStage});\r\n  }\r\n\r\n  async followAction(){\r\n    let user = await this.session(\"user\");\r\n    if(think.isEmpty(user))\r\n      return this.fail();\r\n    let userId = user.id;\r\n    let itemId = this.param(\"itemId\");\r\n    let state = this.param(\"state\");\r\n    if(state)\r\n      return this.success(await this.model(\"follow\").add({user:userId, item:itemId}));\r\n    else\r\n      return this.success(await this.model(\"follow\").where({user:userId, item:itemId}).delete());\r\n  }\r\n\r\n  async groupAction(){\r\n    let groupId = this.param(\"id\");\r\n    console.log(groupId);\r\n    let data = await this.model(\"item_group\").selectData(groupId);\r\n    return this.success(data);\r\n  }\r\n\r\n  async detailAction(){\r\n  \tlet itemId = this.param(\"id\"); //获取item id;\r\n    let resItemInfo = await this._detailHelper(itemId);\r\n    let resRelatedItems = await this._relatedItemHelper(itemId);\r\n    let user = await this.session(\"user\");\r\n    if(!think.isEmpty(user)){\r\n      let userId = user[\"id\"];\r\n      resItemInfo[\"following\"] = await this._followingHelper(userId, itemId);\r\n      for(let r of resRelatedItems)\r\n        r[\"following\"] = await this._followingHelper(userId, r[\"id\"]);\r\n    }else{\r\n      resItemInfo[\"following\"] = null;\r\n      for(let r of resRelatedItems)\r\n        r[\"following\"] = null;\r\n    }\r\n    resItemInfo[\"relatedItems\"] = resRelatedItems;\r\n    return this.success(resItemInfo);\r\n  }\r\n\r\n  async _relatedItemHelper(id,userId){\r\n    let itemInfo = await this.itemModel.setRelation(false).where({\"id\":id}).find();\r\n    let relatedItems = await this.itemModel.setRelation(false).where({\"group\":itemInfo[\"group\"]}).field(\"id\").limit(10).select();\r\n    let res = [];\r\n    for (let r of relatedItems){\r\n      let rDetail = await this._detailHelper(r[\"id\"],userId);\r\n      res.push(rDetail);\r\n    }\r\n    return res;\r\n\r\n  }\r\n\r\n  async _detailHelper(id){\r\n    let itemInfo = await this.itemModel.setRelation(false).where({\"id\":id}).find();\r\n    let imageIds = JSON.parse(itemInfo[\"image\"]) ;\r\n    itemInfo[\"bidCount\"] = await this.model(\"bid\").where({\"item\":id}).count();\r\n    itemInfo[\"followCount\"] = await this.model(\"follow\").where({\"item\":id}).count();\r\n    itemInfo.beginPrice=+itemInfo.beginPrice;\r\n    itemInfo.currentPrice=+itemInfo.currentPrice;\r\n    itemInfo[\"stage\"] = await this.model(\"item\").getStage(itemInfo[\"currentPrice\"]);\r\n    return itemInfo;\r\n  }\r\n\r\n  async _followingHelper(userId, itemId){\r\n    return await this.model(\"follow\").isFollowing(userId, itemId);\r\n  }\r\n}"]}