{"version":3,"sources":["../../../src/api/model/user.js"],"names":[],"mappings":"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","file":"user.js","sourcesContent":["/**\n * Created by zl on 2015/12/30.\n */\nimport Base from './base.js'\n\n\n/**\n * 成功时返回true或者具体对象\n * 失败时返回失败字符串,具体请参看 /src/common/config/local/en.js\n * 如果没有当前需要的失败字符串,请在该文件中定义\n */\nexport default class User extends Base {\n\n  systemUser = 1;\n  /**\n   *\n   * @param username\n   * @param password\n   * @param email\n   * @param role\n   * @returns {*} user object if success, otherwise err string\n   */\n  async createUser(username, password, email, role = 2 /* 'registered'*/) {\n    let creditLines = await think.model('config', null, 'api').get('user.default.creditLines');\n    let desc = await think.model('config', null, 'api').get('user.default.desc');\n    let level = await think.model('config', null, 'api').get('user.default.level');\n    let lastLogin = +new Date();\n\n    let result = await this.where({username}).select();\n    if (!think.isEmpty(result)) {\n      return 'USER_ALREADY_EXIST';\n    }\n    result = await this.where({email}).select();\n    if (!think.isEmpty(result)) {\n      return 'EMAIL_ALREADY_USED';\n    }\n    result = await this.add({username, password, email, role, creditLines,remainCreditLines:creditLines, desc, level, lastLogin});\n\n    return this.where({id: result}).find();\n  }\n\n  /**\n   *\n   * @param username\n   * @param password\n   * @returns {*} user object if success, otherwise err string\n   */\n  async checkUser(username, password) {\n    let result = await this.where({username}).find();\n    if (think.isEmpty(result)) {\n      return 'NO_THIS_USER';\n    }\n    if (result.password != password) {\n      return 'PASSWORD_WORRY';\n    }\n\n    //update last login\n    await this.where({id: result.id}).update({lastLogin: +new Date()});\n    return result;\n  }\n\n  /**\n   *\n   * @param username\n   * @returns {Promise}\n   */\n  delUser(username) {\n    return this.where({username}).delete();\n  }\n\n  /**\n   *\n   * @param username\n   * @returns {Promise<Role>}\n   */\n  async getUserRole(username) {\n    let user = await this.where({username}).find();\n    console.log(user);\n    let roleModel = think.model('role', null, 'api');\n    return roleModel.where({name: user.role}).find();\n  }\n\n  /**\n   *\n   * @param username\n   * @returns {Promise<[Authority]>}\n   */\n  async getUserAuthorities(username) {\n    let roleModel = think.model('role', null, 'api');\n    let user = await this.where({username}).find();\n    let role = await roleModel.where({id: user.role}).find();\n    // console.log(role);\n    return roleModel.getRoleAuthorities(role.name);\n  }\n\n  getTotalVolume(userId) {\n    let orderModel = think.model(\"order\", null, \"api\");\n    return orderModel.where({user: userId}).count();\n  }\n\n  async getTotalTurnover(userId) {\n    let orderModel = think.model(\"order\", null, \"api\");\n    let itemModel = think.model(\"item\", null, \"api\");\n    let itemIds = await orderModel.field(\"item\").where({user: userId}).select();\n    if (think.isEmpty(itemIds))\n      return 0;\n    let itemIdArray = itemIds.map((i)=>i[\"item\"]);\n    return itemModel.where({id: [\"IN\", itemIdArray]}).sum(\"currentPrice\");\n  }\n}"]}