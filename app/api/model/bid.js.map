{"version":3,"sources":["../../../src/api/model/bid.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;;;IAEqB,G;;;;;;;;gBACnB,O,oBAAQ,M,EAAO;AACb,WAAO,KAAK,IAAL,CAAU,0BAAV,EACJ,KADI,CACE,qGADF,EAEJ,KAFI,CAEE,EAAC,MAAK,MAAN,EAFF,EAEiB,MAFjB,EAAP;AAGD,G;;gBAED,e,4BAAgB,M,EAAO;AACrB,WAAO,KAAK,KAAL,CAAW,EAAC,MAAK,MAAN,EAAX,EACJ,QADI,CACK,MADL,EAEJ,MAFI,EAAP;AAGD,G;;gBACD,Y,yBAAa,M,EAAQ,K,EAAM;AACzB,WAAO,KAAK,IAAL,CAAU,4BAAV,EACJ,KADI,CACE,qEADF,EAEJ,KAFI,CAEE,EAAC,MAAK,MAAN,EAAa,OAAM,EAAC,KAAI,KAAL,EAAnB,EAFF,EAGJ,KAHI,CAGE,mBAHF,EAIJ,IAJI,EAAP;AAKD,G;AACD;AACA;;;gBACA,W,wBAAY,M,EAAO;AACjB,WAAO,KAAK,KAAL,CAAW,KAAX,EACJ,IADI,CACC,4BADD,EAEJ,KAFI,CAEE,oHAFF,EAGJ,KAHI,CAGE,gBAAgB,MAHlB,EAIJ,MAJI,EAAP;AAKD,G;AACD;;;gBACM,S;2FAAU,K;;;;;;AACd,sBAAQ,GAAR,CAAY,KAAZ;AACI,iB,GAAM,C;;qBACO,KAAK,KAAL,CAAW,EAAC,IAAG,KAAJ,EAAX,EAAuB,MAAvB,E;;;AAAb,iB,iBAA8C,C;AAC9C,oB,GAAS,IAAI,MAAJ,C;AACT,oB,GAAS,IAAI,MAAJ,C;AACT,uB,GAAY,MAAM,KAAN,CAAY,MAAZ,EAAmB,IAAnB,EAAwB,KAAxB,C;;qBACE,UAAU,KAAV,CAAgB,EAAC,IAAG,MAAJ,EAAhB,EAA6B,MAA7B,E;;;AAAd,kB,iBAAqD,C;;AACzD,sBAAQ,GAAR,CAAY,IAAZ;;oBACG,KAAK,QAAL,KAAkB,UAAU,aAA5B,IAA6C,KAAK,eAAL,KAAyB,M;;;;;AACvE,oBAAM,CAAN;;;;;oBACM,KAAK,QAAL,KAAkB,UAAU,aAA5B,IAA6C,KAAK,QAAL,KAAkB,UAAU,c;;;;;AAC/E,oBAAM,CAAN;;;;;oBACM,KAAK,QAAL,KAAkB,UAAU,U;;;;;;qBACb,KAAK,KAAL,CAAW,EAAC,MAAK,MAAN,EAAX,EAA0B,GAA1B,CAA8B,OAA9B,C;;;AAAjB,sB;;AACJ,sBAAQ,GAAR,CAAY,QAAZ;AACA,kBAAG,YAAY,IAAI,OAAJ,CAAf,EACE,MAAM,CAAN,CADF,KAEK,MAAM,CAAN;;;+CAEA,G;;;;;;;;;;;;;;;;;;;;kBAjDU,G","file":"bid.js","sourcesContent":["import Base from './base.js'\r\n\r\nexport default class Bid extends Base {\r\n  getList(userId){\r\n    return this.join(\"item on bid.item=item.id\")\r\n      .field(\"bid.id as bid,value as price,bid.createAt,item.name as name,item.id as id,item.status as itemStatus\")\r\n      .where({user:userId}).select();\r\n  }\r\n\r\n  getDistinctList(userId){\r\n    return this.where({user:userId})\r\n      .distinct(\"item\")\r\n      .select();\r\n  }\r\n  getPriceOver(itemId, price){\r\n    return this.join(\"item on bid.item = item.id\")\r\n      .field(\"bid.createAt as time, bid.item as id, bid.value as price, item.name\")\r\n      .where({item:itemId,value:{\">\":price}})\r\n      .order(\"bid.createAt DESC\")\r\n      .find();\r\n  }\r\n  // 查询某件物品的所有竞标记录\r\n  // 返回值 id, userId, username, value, status\r\n  getItemBids(itemId){\r\n    return this.model(\"bid\")\r\n      .join(\"user on bid.user = user.id\")\r\n      .field(\"bid.id as id, bid.user as userId, user.username as username, bid.value as price, bid.status as status,bid.createAt\")\r\n      .where(\"bid.item = \" + itemId)\r\n      .select();\r\n  }\r\n  // 查询竞标状态：'得标', '失败', '领先', '被超'\r\n  async getStatus(bidId){\r\n    console.log(bidId);\r\n    let res = 3;\r\n    let bid = (await this.where({id:bidId}).select())[0];\r\n    let itemId = bid[\"item\"];\r\n    let userId = bid[\"user\"];\r\n    let itemModel = think.model(\"item\",null,\"api\");\r\n    let item = (await itemModel.where({id:itemId}).select())[0];\r\n    console.log(item);\r\n    if(item[\"status\"] == itemModel.AUCTION_ENDED && item[\"currentBidder\"] == userId)\r\n      res = 0;\r\n    else if(item[\"status\"] == itemModel.AUCTION_ENDED || item[\"status\"] == itemModel.AUCTION_FAILED)\r\n      res = 1;\r\n    else if(item[\"status\"] == itemModel.AUCTIONING){\r\n      let maxPrice = await this.where({item:itemId}).max(\"value\");\r\n      console.log(maxPrice);\r\n      if(maxPrice == bid[\"value\"])\r\n        res = 2;\r\n      else res = 3;\r\n    }\r\n    return res;\r\n  }\r\n}"]}