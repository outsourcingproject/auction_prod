{"version":3,"sources":["../../../src/api/model/bid.js"],"names":[],"mappings":"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","file":"bid.js","sourcesContent":["import Base from './base.js'\n\nexport default class Bid extends Base {\n  WINNING = 0; // 得标\n  FAILING = 1; //失败\n  LEADING = 2; //领先\n  FALLING = 3; //落后\n\n  STATUS = [\"得标\",\"竞标失败\",\"暂时领先\",\"被超越\"];\n\n  // init(...args){\n  //   super.init(...args);\n  //   this.systemUser = User.systemUser;\n  // }\n\n\n\n  getList(userId){\n    return this.join(\"item on bid.item=item.id\")\n      .field(\"bid.id as bid,value as price,bid.createAt,item.name as name,item.id as id,item.status as itemStatus, bid.status as bidStatus\")\n      .where({user:userId}).select();\n  }\n\n  getDistinctList(userId){\n    return this.where({user:userId})\n      .distinct(\"item\")\n      .select();\n  }\n  getPriceOver(userId){\n    return this.join(\"item on bid.item = item.id\")\n      .field(\"bid.createAt as time, bid.item as id, bid.value as price, item.name\")\n      .where(\"user =\" + userId +\" and bid.status = \" + this.FALLING)\n      .order(\"bid.createAt DESC\")\n      .find();\n  }\n  // 查询某件物品的所有竞标记录\n  // 返回值 id, userId, username, value, status\n  getItemBids(itemId){\n    return this.model(\"bid\")\n      .join(\"user on bid.user = user.id\")\n      .field(\"bid.id as id, bid.user as userId, user.username as username, bid.value as price, bid.status as status,bid.createAt\")\n      .where(\"bid.item = \" + itemId)\n      .select();\n  }\n//Object:{user:userId, item:item, value:value, status:this.model(\"bid\").LEADING}\n  async addOne(bid){\n    let userModel = think.model(\"user\",null,\"api\");\n    let messageModel = think.model(\"message\",null,\"api\");\n    let itemModel = think.model(\"item\",null,\"api\");\n    try{\n      await this.startTrans();\n      let bidId = await this.add(bid);\n      let item = await itemModel.where({id:bid.item}).find();\n      //发送暂时领先系统消息\n      await messageModel.sendSystemMessage([{from:userModel.systemUser, to:bid.user, title:\"系统消息：您的出价领先\", content:\"您的商品\"+item.name+this.STATUS[bid.status], read:0}])\n\n      //更新被超越竞标记录的状态\n\n      let bids = await this.where({value:{\"<\":bid.value},item:bid.item,user:{\"!=\":bid.user},status:{\"!=\":this.FALLING}}).distinct(\"user\").select();\n      console.log(bids);\n      await this.where({value:{\"<\":bid.value},item:bid.item})\n                .update({status:this.FALLING});\n      //给被超越竞标记录的用户发送消息\n      let messages = bids.map((b)=>{return {from:userModel.systemUser, to:b.user, title:\"系统消息：您的出价被超越\", content:\"您的商品\"+item.name+this.STATUS[3], read:0}});\n      if(!think.isEmpty(messages)){\n          await messageModel.sendSystemMessage(messages);   \n      }\n      await this.commit();\n      return bidId;\n    }catch(e){\n      await this.rollback();\n      return 0;\n    }  \n  }\n\n  // 查询竞标状态：'得标', '失败', '领先', '被超'\n  // async getStatus(bidId){\n  //   console.log(bidId);\n  //   let res = 3;\n  //   let bid = await this.where({id:bidId}).find();\n  //   let itemId = bid[\"item\"];\n  //   let userId = bid[\"user\"];\n  //   let itemModel = think.model(\"item\",null,\"api\");\n  //   let item = (await itemModel.where({id:itemId}).select())[0];\n  //   console.log(item);\n  //   if(item[\"status\"] == itemModel.AUCTION_ENDED && item[\"currentBidder\"] == userId)\n  //     res = 0;\n  //   else if(item[\"status\"] == itemModel.AUCTION_ENDED || item[\"status\"] == itemModel.AUCTION_FAILED)\n  //     res = 1;\n  //   else if(item[\"status\"] == itemModel.AUCTIONING){\n  //     let maxPrice = await this.where({item:itemId}).max(\"value\");\n  //     console.log(maxPrice);\n  //     if(maxPrice == bid[\"value\"])\n  //       res = 2;\n  //     else res = 3;\n  //   }\n  //   return res;\n  // }\n}"]}