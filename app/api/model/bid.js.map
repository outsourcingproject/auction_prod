{"version":3,"sources":["../../../src/api/model/bid.js"],"names":[],"mappings":"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","file":"bid.js","sourcesContent":["import Base from './base.js'\r\n\r\nexport default class Bid extends Base {\r\n  WINNING = 0; // 得标\r\n  FAILING = 1; //失败\r\n  LEADING = 2; //领先\r\n  FALLING = 3; //落后\r\n\r\n  STATUS = [\"得标\",\"竞标失败\",\"暂时领先\",\"被超越\"];\r\n\r\n  // init(...args){\r\n  //   super.init(...args);\r\n  //   this.systemUser = User.systemUser;\r\n  // }\r\n\r\n\r\n\r\n  getList(userId){\r\n    return this.join(\"item on bid.item=item.id\")\r\n      .field(\"bid.id as bid,value as price,bid.createAt,item.name as name,item.id as id,item.status as itemStatus, bid.status as bidStatus\")\r\n      .where({user:userId}).select();\r\n  }\r\n\r\n  getDistinctList(userId){\r\n    return this.where({user:userId})\r\n      .distinct(\"item\")\r\n      .select();\r\n  }\r\n  getPriceOver(userId){\r\n    return this.join(\"item on bid.item = item.id\")\r\n      .field(\"bid.createAt as time, bid.item as id, bid.value as price, item.name\")\r\n      .where(\"user =\" + userId +\" and bid.status = \" + this.FALLING)\r\n      .order(\"bid.createAt DESC\")\r\n      .find();\r\n  }\r\n  // 查询某件物品的所有竞标记录\r\n  // 返回值 id, userId, username, value, status\r\n  getItemBids(itemId){\r\n    return this.model(\"bid\")\r\n      .join(\"user on bid.user = user.id\")\r\n      .field(\"bid.id as id, bid.user as userId, user.username as username, bid.value as price, bid.status as status,bid.createAt\")\r\n      .where(\"bid.item = \" + itemId)\r\n      .select();\r\n  }\r\n//Object:{user:userId, item:item, value:value, status:this.model(\"bid\").LEADING}\r\n  async addOne(bid){\r\n    let userModel = think.model(\"user\",null,\"api\");\r\n    let messageModel = think.model(\"message\",null,\"api\");\r\n    let itemModel = think.model(\"item\",null,\"api\");\r\n    try{\r\n      await this.startTrans();\r\n      let bidId = await this.add(bid);\r\n      let item = await itemModel.where({id:bid.item}).find();\r\n      //发送暂时领先系统消息\r\n      await messageModel.sendSystemMessage([{from:userModel.systemUser, to:bid.user, title:\"系统消息\", content:\"您的商品\"+item.name+this.STATUS[bid.status], read:0}])\r\n\r\n      //更新被超越竞标记录的状态\r\n\r\n      let bids = await this.where({value:{\"<\":bid.value},item:bid.item,user:{\"!=\":bid.user},status:{\"!=\":this.FALLING}}).distinct(\"user\").select();\r\n      console.log(bids);\r\n      await this.where({value:{\"<\":bid.value},item:bid.item})\r\n                .update({status:this.FALLING});\r\n      //给被超越竞标记录的用户发送消息\r\n      let messages = bids.map((b)=>{return {from:userModel.systemUser, to:b.user, title:\"系统消息\", content:\"您的商品\"+item.name+this.STATUS[3], read:0}});\r\n      if(!think.isEmpty(messages)){\r\n          await messageModel.sendSystemMessage(messages);   \r\n      }\r\n      await this.commit();\r\n      return bidId;\r\n    }catch(e){\r\n      await this.rollback();\r\n      return 0;\r\n    }  \r\n  }\r\n\r\n  // 查询竞标状态：'得标', '失败', '领先', '被超'\r\n  // async getStatus(bidId){\r\n  //   console.log(bidId);\r\n  //   let res = 3;\r\n  //   let bid = await this.where({id:bidId}).find();\r\n  //   let itemId = bid[\"item\"];\r\n  //   let userId = bid[\"user\"];\r\n  //   let itemModel = think.model(\"item\",null,\"api\");\r\n  //   let item = (await itemModel.where({id:itemId}).select())[0];\r\n  //   console.log(item);\r\n  //   if(item[\"status\"] == itemModel.AUCTION_ENDED && item[\"currentBidder\"] == userId)\r\n  //     res = 0;\r\n  //   else if(item[\"status\"] == itemModel.AUCTION_ENDED || item[\"status\"] == itemModel.AUCTION_FAILED)\r\n  //     res = 1;\r\n  //   else if(item[\"status\"] == itemModel.AUCTIONING){\r\n  //     let maxPrice = await this.where({item:itemId}).max(\"value\");\r\n  //     console.log(maxPrice);\r\n  //     if(maxPrice == bid[\"value\"])\r\n  //       res = 2;\r\n  //     else res = 3;\r\n  //   }\r\n  //   return res;\r\n  // }\r\n}"]}