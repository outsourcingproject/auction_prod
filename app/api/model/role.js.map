{"version":3,"sources":["../../../src/api/model/role.js"],"names":[],"mappings":"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","file":"role.js","sourcesContent":["import Base from './base'\n\nexport default class Role extends Base {\n\n  // schemas = {\n  //   name: {\n  //     required: true,\n  //     default: '',\n  //     unique: true\n  //   },\n  //   desc: {\n  //     required: true,\n  //     default: ''\n  //   },\n  //   //继承那些角色的权限\n  //   extend: {\n  //     //ref to collection Role.name\n  //     type: [String],\n  //     required: true,\n  //     default: []\n  //   },\n  //   authorities: {\n  //     default: [],\n  //     type: [ObjectID]\n  //   },\n  //   createAt: {\n  //     type: Date,\n  //     required: true,\n  //     default: ()=>new Date()\n  //   },\n  //   updateAt: {\n  //     type: Date,\n  //     required: true,\n  //     default: ()=>new Date()\n  //   }\n  // };\n\n  // indexeses={\n  //   name:{$unique: 1}\n  // };\n  \n  /**\n   *\n   * @param name\n   * @param desc\n   * @param extend {[String]}\n   * @param authorities {[String]} authority name list\n   * @returns {*} true if success, otherwise err string\n   */\n  async addRole(name, desc = '', extend = ['anonymous', 'registered'], authorities = []) {\n\n    let roleAuthorityModel=think.model('role_authority',null,'api');\n\n    extend=JSON.stringify(extend);\n    let result = await this.thenAdd({name, desc, extend}, {name});\n\n    if (result.type == 'add') {\n      await roleAuthorityModel.addRoleAuthorities(name,...authorities);\n      return true;\n    } else {\n      return 'ROLE_ALREADY_EXIST';\n    }\n  }\n\n  /**\n   * TODO: del other role's extend\n   * TODO: del user's role, if none, should assign to what\n   * @param name {String}\n   * @returns {Promise}\n   */\n  delRole(name) {\n    return this.where({name}).delete();\n  }\n\n\n  /**\n   *\n   * @param name {String} name of role\n   * @param authorities {String} authorities' name\n   * @returns {Promise}\n   */\n  rmAuthorities(name, ...authorities) {\n\n    let role = this.where({name}).find();\n    for (let authority of authorities) {\n      let index = role.authorities.indexOf(authority);\n      if (index >= 0) {\n        role.authorities.slice(index, 1);\n      }\n    }\n    return this.where({name}).update({authorities});\n  }\n\n  /**\n   *\n   * @param name {String}\n   * @param newName {String}\n   * @returns {Promise}\n   */\n  changeName(name, newName) {\n    return this.where({name}).update({name: newName});\n  }\n\n  /**\n   *\n   * @param name {String}\n   * @param desc {desc}\n   * @returns {Promise}\n   */\n  changeDesc(name, desc) {\n    return this.where({name}).update({desc});\n  }\n\n  /**\n   *\n   * @param name {String} name of role\n   * @returns {Promise<[Authority]>} authority's array\n   */\n  async getRoleAuthorities(name) {\n    let authorityModel = think.model('authority', null, 'api');\n\n    let getAuthorities = async(name)=> {\n      let role = await this.where({name}).find();\n      if (think.isEmpty(role)) {\n        return [];\n      }\n      let authorities = [];\n      for (let e of JSON.parse(role.extend)) {\n        authorities.push(await getAuthorities(e));\n      }\n      let roleAuthorityModel = think.model('role_authority', null, 'api');\n      authorities.push(await roleAuthorityModel.where({role: role.id}).find());\n      return authorities;\n    };\n\n    return getAuthorities(name);\n  };\n}"]}